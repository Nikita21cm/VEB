<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–∞–±–∏–Ω–µ—Ç - EcoNova Hub</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ */
    .report-box { margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    .report-box p { margin: 5px 0; }
    .report-box button { margin-right: 8px; padding: 6px 10px; border: none; background: #bb86fc; color: #121212; border-radius: 4px; cursor: pointer; }
    .report-box button:hover { background: #9c6dd0; }
    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ */
    .report-form-container {
      max-width: 500px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <header class="sub-header">
    <div class="container nav-wrapper">
      <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
      <nav class="sub-nav">
        <a href="index.html" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="waste_types.html" class="nav-link">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
        <a href="collection_points.html" class="nav-link">–¶–µ–Ω—Ç—Ä—ã</a>
        <a href="chat.html" class="nav-link" target="_blank">AI –ß–∞—Ç</a>
        <a href="https://t.me/YourBotUsername" class="nav-link" target="_blank">TG –ë–æ—Ç</a>
      </nav>
    </div>
  </header>
  <main class="container">
    <section id="userInfo" class="info-box">
      <h2>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, <span id="username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>!</h2>
      <p>ID: <span id="userId">-</span></p>
    </section>
    <section id="addReportSection" class="form-page report-form-container">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</h2>
      <form id="reportForm" class="form-box">
        <input type="number" id="wasteTypeId" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (ID)" required>
        <input type="number" id="collectionPointId" placeholder="–¶–µ–Ω—Ç—Ä (ID)" required>
        <input type="number" step="0.01" id="reportWeight" placeholder="–í–µ—Å (–∫–≥)" required>
        <input type="date" id="reportDate" required>
        <button type="submit" class="btn submit-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
    </section>
    <section id="reportsSection">
      <h2>–ú–æ–∏ –æ—Ç—á—ë—Ç—ã</h2>
      <div id="reportsContainer">
        <!-- –û—Ç—á—ë—Ç—ã –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —Å—é–¥–∞ -->
      </div>
    </section>
    <section id="contributionSection" class="info-box">
      <h2>–í–∞—à –≤–∫–ª–∞–¥ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
      <div id="contributionContainer" class="message-box">
        <p>–û–±—â–∏–π –≤–µ—Å: <span id="totalWeight">0</span> –∫–≥</p>
        <p>–≠–∫–æ-–±–æ–Ω—É—Å—ã: <span id="ecoPoints">0</span></p>
        <div id="achievementsList"></div>
      </div>
    </section>
  </main>
  <footer class="site-footer">
    <p>&copy; 2025 EcoNova Hub. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </footer>
  <script>
    const apiLink = "http://eco-hub.econova-hub.ru"
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user){
      window.location.href = "login.html";
    } else {
      document.getElementById('username').textContent = user.username;
      document.getElementById('userId').textContent = user.id;
      loadReports(user.id);
      loadContribution(user.id);
    }
    
    async function loadReports(userId) {
      try {
        const response = await fetch(`${apiLink}/api/reports?user_id=${userId}`);
        if(!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        const reports = await response.json();
        const container = document.getElementById('reportsContainer');
        container.innerHTML = '';
        if(reports.length === 0) {
          container.innerHTML = '<p>–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤.</p>';
        } else {
          reports.forEach(rep => {
            const div = document.createElement('div');
            div.classList.add('card', 'report-box');
            div.innerHTML = `
              <p><strong>ID:</strong> ${rep.id}</p>
              <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${rep.waste_type_id}</p>
              <p><strong>–¶–µ–Ω—Ç—Ä:</strong> ${rep.collection_point_id}</p>
              <p><strong>–í–µ—Å:</strong> ${rep.weight} –∫–≥</p>
              <p><strong>–î–∞—Ç–∞:</strong> ${rep.report_date}</p>
              <button onclick="editReport(${rep.id}, this)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button onclick="deleteReport(${rep.id})">–£–¥–∞–ª–∏—Ç—å</button>
            `;
            container.appendChild(div);
          });
        }
      } catch (err) {
        console.error(err);
      }
    }
    
    async function addReport(event) {
      event.preventDefault();
      const data = {
        user_id: user.id,
        waste_type_id: document.getElementById('wasteTypeId').value,
        collection_point_id: document.getElementById('collectionPointId').value,
        weight: document.getElementById('reportWeight').value,
        report_date: document.getElementById('reportDate').value
      };
      try {
        const response = await fetch(`${apiLink}/api/reports`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if(!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        document.getElementById('reportForm').reset();
        loadReports(user.id);
        loadContribution(user.id);
      } catch (err) {
        console.error(err);
      }
    }
    
    async function editReport(reportId, btn) {
      const card = btn.parentElement;
      const currentType = card.querySelector('p:nth-child(2)').textContent.split(':')[1].trim();
      const currentPoint = card.querySelector('p:nth-child(3)').textContent.split(':')[1].trim();
      const currentWeight = card.querySelector('p:nth-child(4)').textContent.split(':')[1].trim().split(' ')[0];
      const currentDate = card.querySelector('p:nth-child(5)').textContent.split(':')[1].trim();
      
      const newType = prompt("–ù–æ–≤—ã–π ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", currentType);
      if(newType === null) return;
      const newPoint = prompt("–ù–æ–≤—ã–π ID —Ü–µ–Ω—Ç—Ä–∞:", currentPoint);
      if(newPoint === null) return;
      const newWeight = prompt("–ù–æ–≤—ã–π –≤–µ—Å (–∫–≥):", currentWeight);
      if(newWeight === null) return;
      const newDate = prompt("–ù–æ–≤–∞—è –¥–∞—Ç–∞ (YYYY-MM-DD):", currentDate);
      if(newDate === null) return;
      
      const data = {
        user_id: user.id,
        waste_type_id: newType,
        collection_point_id: newPoint,
        weight: newWeight,
        report_date: newDate
      };
      
      try {
        const response = await fetch(`${apiLink}/api/reports/${reportId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if(!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        loadReports(user.id);
        loadContribution(user.id);
      } catch (err) {
        console.error(err);
      }
    }
    
    async function deleteReport(reportId) {
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á—ë—Ç?")) return;
      try {
        const response = await fetch(`${apiLink}/api/reports/${reportId}`, {
          method: 'DELETE'
        });
        if(!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        loadReports(user.id);
        loadContribution(user.id);
      } catch (err) {
        console.error(err);
      }
    }
    
    document.getElementById('reportForm').addEventListener('submit', addReport);
    
    async function loadContribution(userId) {
      try {
        const response = await fetch(`${apiLink}/api/contribution?user_id=${userId}`);
        if(!response.ok) throw new Error(`–û—à–∏–±–∫–∞: ${response.status}`);
        const data = await response.json();
        document.getElementById('totalWeight').textContent = data.totalWeight || 0;
        document.getElementById('ecoPoints').textContent = data.points || 0;
        loadAchievements(data.points || 0);
      } catch (err) {
        console.error(err);
      }
    }
    
    function loadAchievements(points) {
      const achievementsList = document.getElementById('achievementsList');
      let html = "";
      if (points >= 1000) {
        html += "<p>üèÜ –ú–∞—Å—Ç–µ—Ä –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏: —Å–≤—ã—à–µ 1000 –±–æ–Ω—É—Å–æ–≤!</p>";
      } else if (points >= 500) {
        html += "<p>ü•à –û–ø—ã—Ç–Ω—ã–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç—á–∏–∫: —Å–≤—ã—à–µ 500 –±–æ–Ω—É—Å–æ–≤!</p>";
      } else if (points >= 100) {
        html += "<p>ü•â –ù–∞—á–∏–Ω–∞—é—â–∏–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç—á–∏–∫: —Å–≤—ã—à–µ 100 –±–æ–Ω—É—Å–æ–≤!</p>";
      } else {
        html += "<p>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –î–æ–±–∞–≤–ª—è–π—Ç–µ –æ—Ç—á—ë—Ç—ã –¥–ª—è –±–æ–Ω—É—Å–æ–≤!</p>";
      }
      achievementsList.innerHTML = html;
    }
  </script>
</body>
</html>
